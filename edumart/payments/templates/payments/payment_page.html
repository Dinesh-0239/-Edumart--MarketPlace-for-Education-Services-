{% extends 'home_base.html' %}
{% load static %}
{% block title %} Payment | {{booking.service.title}} {% endblock %}
{% block style %} <link rel="stylesheet" href="{% static 'css/payment_style.css' %}"> {% endblock %}
{% block content %}
<br>
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Secure Payment</h3>
                </div>
                <div class="card-body">
                    <!-- Test Mode Instructions -->
                    <div class="alert alert-info">
                        <h5 class="alert-heading">Test Mode Instructions</h5>
                        <p>Use these test card details:</p>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header bg-success text-white">
                                        Success Card
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Card Number:</strong> {{ test_cards.success.number }}</p>
                                        <p><strong>CVV:</strong> {{ test_cards.success.cvv }}</p>
                                        <p><strong>Expiry:</strong> {{ test_cards.success.expiry }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header bg-danger text-white">
                                        Failure Card
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Card Number:</strong> {{ test_cards.failure.number }}</p>
                                        <p><strong>CVV:</strong> {{ test_cards.failure.cvv }}</p>
                                        <p><strong>Expiry:</strong> {{ test_cards.failure.expiry }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Booking Details -->
                    <div class="booking-details mb-4">
                        <h4>Booking Details</h4>
                        <div class="table-responsive">
                            <table class="table">
                                <tr>
                                    <th>Service:</th>
                                    <td>{{ booking.service.title }}</td>
                                </tr>
                                <tr>
                                    <th>Provider:</th>
                                    <td>{{ booking.service.provider.username}}</td>
                                </tr>
                                <tr>
                                    <th>Amount:</th>
                                    <td>â‚¹{% widthratio amount 100 1 %}.00</td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- Payment Buttons -->
                    <div class="text-center">
                        <button id="rzp-button" class="btn btn-primary btn-lg">
                            <i class="fas fa-lock mr-2"></i>Pay Securely
                        </button>
                        <a href="{% url 'profile' %}" class="btn btn-secondary btn-lg ml-2">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<br>
{% endblock %}

{% block script %} 
<!-- Razorpay Integration -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    var options = {
        "key": "{{ razorpay_merchant_key }}",
        "amount": "{{ amount }}",
        "currency": "{{ currency }}",
        "name": "EduMart",
        "description": "Payment for {{ booking.service.title }}",
        "order_id": "{{ order_id }}",
        "handler": function (response) {
            // Create form for payment verification
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = "{{ callback_url }}";
            
            // Add CSRF token
            var csrf = document.createElement('input');
            csrf.name = "csrfmiddlewaretoken";
            csrf.value = "{{ csrf_token }}";
            csrf.type = 'hidden';
            form.appendChild(csrf);
            
            // Add payment response fields
            var fields = ['razorpay_payment_id', 'razorpay_order_id', 'razorpay_signature'];
        fields.forEach(field => {
            if(response[field]){
                var input = document.createElement('input');
                input.name = field;
                input.value = response[field];
                input.type = 'hidden';
                form.appendChild(input);
            }
        });
        
        // Submit form
        document.body.appendChild(form);
        form.submit();
    },
    "prefill": {
        "name": "{{ request.user.get_full_name }}",
        "email": "{{ request.user.email }}",
        "contact": "{{ request.user.phone_number|default:'' }}"
    },
    "theme": {
        "color": "#3399cc"
    },
    "modal": {
        "ondismiss": function(){
            window.location.href = "{% url 'profile' %}";
        }
    }
};

// Initialize Razorpay
var rzp = new Razorpay(options);

// Handle payment button click
document.getElementById('rzp-button').onclick = function(e){
    rzp.open();
    e.preventDefault();
}
</script>
{% endblock %}